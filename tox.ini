[tox]
envlist = py, lint, fmt

[testenv]
description = run tests with pytest with coverage
extras =
    all
    dev-test
passenv =
    LOG_LEVEL
    LOG_FILTERS
    LOG_FORMATTER
    LOG_THREAD_ID
    LOG_CHANNEL_WIDTH
setenv =
    DFTYPE = pandas_all
    VLLM_LOGGING_LEVEL = DEBUG
    VLLM_TARGET_DEVICE=cpu

allowlist_externals = 
    git 
    rm
    sh

# ── BEFORE running pytest, build & install vLLM v0.8.4 CPU-only from source ──
commands_pre =
    # 1) clone exactly vLLM v0.8.4
    rm -rf {envtmpdir}/vllm_source
    git clone --branch v0.8.4 \
      https://github.com/vllm-project/vllm.git {envtmpdir}/vllm_source

    # 2) install its Python build deps
    {envpython} -m pip install --upgrade pip
    {envpython} -m pip install "cmake>=3.26" wheel packaging ninja "setuptools-scm>=8" numpy
    {envpython} -m pip install -v -r {envtmpdir}/vllm_source/requirements/cpu.txt \
        --extra-index-url https://download.pytorch.org/whl/cpu

    # 3) build & install vLLM in CPU mode
    sh -c "cd {envtmpdir}/vllm_source && VLLM_TARGET_DEVICE=cpu {envpython} setup.py install"
    #{envpython} -m pip install {envtmpdir}/vllm_source

commands = pytest -s --cov=vllm_detector_adapter --cov-report=html:coverage-{env_name} --cov-report=xml:coverage-{env_name}.xml --html=durations/{env_name}.html {posargs:tests} -W error::UserWarning
; -W ignore::DeprecationWarning


; Unclear: We probably want to test wheel packaging
; But! tox will fail when this is set and _any_ interpreter is missing
; Without this, sdist packaging is tested so that's a start.
package=wheel

[testenv:fmt]
description = format with pre-commit
extras = dev-fmt
commands = ./scripts/fmt.sh
allowlist_externals = ./scripts/fmt.sh

[testenv:lint]
description = lint with ruff
extras =
    dev-fmt
commands = ruff check vllm_detector_adapter
